# Debug 輸出標準化設計（草案）

本文件定義專案的 Debug 訊息統一規格，目標：
- 長行自動換行，每行都有時間戳（沿用 timestamped_print）
- 前綴（prefix）一致、可讀；支援每行重覆前綴
- 多線程/多檔案事件交錯時，能看出訊息屬於「第幾組事件」（事件編號/檔案群組）
- 提供 Debug 等級，控制輸出詳盡程度

---

## 1. 設定項（新增）
- DEBUG_LEVEL: int（0/1/2/3）
  - 0：不輸出 debug
  - 1（基本）：路由、queue submit、value-engine 選擇、map 提供/keys 數量（不展開大列表）、copy 簡要、timeline-html 多行概要
  - 2（詳盡）：map 展示前 N 個 keys（例如每行 10 個）；copy 的 exec/rc 摘要；robocopy/powershell 的 stdout/stderr 片段（截斷）
  - 3（非常詳盡）：map 展示更多 keys（擴大限額），stdout/stderr 更長（或不截斷）
- DEBUG_WRAP_WIDTH: int（預設 120；0 則沿用 CONSOLE_TERM_WIDTH_OVERRIDE 或 120）
- DEBUG_MAX_LIST_ITEMS: int（預設 20；列表/keys 顯示上限）
- DEBUG_TRUNCATE_BYTES: int（預設 2000；外部命令 stdout/stderr 截斷長度）
- DEBUG_REPEAT_PREFIX_ON_WRAP: bool（預設 True；換行後每行是否重覆 prefix）
- DEBUG_TAG_EVENT_ID: bool（預設 True；是否在每行加上事件編號標籤）

UI：在「可靠性與資源」或「日誌與輸出」分頁新增以上項目（灰字說明沿用本文件敘述）。

---

## 2. 前綴（prefix）分類
- [route] 路由判斷（watch / monitor-only）
- [copy] 檔案複製（exec、rc、stdout/stderr、copy-ok 等）
- [value-engine] 值引擎選擇/切換/版本
- [map] 工作表對映（provided/keys 展示）
- [fallback] 回退原因
- [queue] 比較任務佇列（submit、pending 數）
- [poll] 輪詢檢查（穩定窗口、冷靜期）
- [timeline-html] timeline 生成路徑與摘要
- [event-txt] 事件詳版匯出（多表）

---

## 3. 事件/群組標籤
- 目的：多線程/多檔案事件交錯時，讓使用者知道每行屬於「第幾組事件」。
- 規則：
  - 若有 event_number：在 prefix 前加入 [evt#XXXX]（零填充 4 位，如 0020）
  - 若無 event_number：可用檔案群組（baseline key）取代，如 [bk:New Test File 21.xlsx__abcd1234]
- 綜合前綴：
  - [evt#0020][map] ...
  - [bk:New Test File 21.xlsx__abcd1234][copy] ...

---

## 4. 換行與縮排規則
- 所有輸出仍經 timestamped_print，每一行自動加時間戳。
- 多行輸出：
  - 第一行：`[evt#0020][prefix] 主訊息`
  - 後續行：
    - 若 DEBUG_REPEAT_PREFIX_ON_WRAP=True：每行都以 `[evt#0020][prefix]` 開頭
    - 否則以固定縮排（例如兩個空格）對齊
- 字串：按 DEBUG_WRAP_WIDTH（或 CONSOLE_TERM_WIDTH_OVERRIDE）切行，支援 CJK 寬度（wrap_text_with_cjk_support）。
- 列表：
  - 按 chunk（10 項/行）輸出：`keys(1/8): A1, C1, ...`
  - 超出 DEBUG_MAX_LIST_ITEMS 時，用 `... (+N more)` 表示截斷
- 鍵值對：每行 `key=value`，key 左對齊固定寬度（如 14），方便掃讀。

---

## 5. 範例

### 5.1 [map] 長 keys 列表
原始：
```
[map] ws_index=1 ws_title='工作表 1 (2)' -> key='工作表 1 (2)' provided=71 keys=['A1','C1',...]
```
標準化（每行 10 項；每行有時間戳與 prefix）：
```
[evt#0020][map] ws_index=1 ws_title='工作表 1 (2)' -> key='工作表 1 (2)' provided=71
[evt#0020][map] keys(1/8): A1, C1, E1, G1, H1, A2, C2, G2, H2, A3
[evt#0020][map] keys(2/8): C3, D3, G3, H3, L3, F5, I5, L5, O5, A6
...
```

### 5.2 [copy] exec PowerShell 命令
原始：
```
[DEBUG] exec: powershell -NoProfile -Command Copy-Item -LiteralPath 'C:\..' -Destination 'C:\..' -Force
```
標準化：
```
[evt#0020][copy] exec: powershell -NoProfile -Command Copy-Item
[evt#0020][copy]        -LiteralPath 'C:\Users\user\Desktop\pytest - 複製\!space folder\New Test File 21 - 複製 (2).xlsx'
[evt#0020][copy]        -Destination 'C:\Users\user\Desktop\watchdog\cache_folder\52f8..._New Test File 21 - 複製 (2).xlsx'
[evt#0020][copy]        -Force
```

### 5.3 [timeline-html] 多行詳細
方案 A（每行 prefix）：
```
[timeline-html] dir=C:\Users\user\Desktop\Datacamp\timeline
[timeline-html] json=C:\Users\user\Desktop\Datacamp\timeline\events.json
[timeline-html] html=C:\Users\user\Desktop\Datacamp\timeline\index.html
[timeline-html] events=25
[timeline-html] last_file=C:\Users\user\Desktop\pytest - 複製\!space folder\New Test File 21 - 複製 (2).xlsx
```
方案 B（一次 prefix + 縮排）：
```
[timeline-html]
  dir=...
  json=...
  html=...
  events=...
  last_file=...
```

---

## 6. 等級對應（示例）
- Level 1：
  - [route]、[queue] submit、[value-engine] 選擇、[map] provided=與 keys 數量
  - [copy] 簡要（exec 一行、rc 簡述）
  - [timeline-html] 多行概要
- Level 2：
  - [map] 顯示前 DEBUG_MAX_LIST_ITEMS（每行 10 項）；
  - [copy] exec 分行；robocopy/powershell stdout/stderr 截斷（DEBUG_TRUNCATE_BYTES）
- Level 3：
  - [map] 顯示更多 keys；
  - [copy] stdout/stderr 提高截斷或不截斷

---

## 7. 實作建議（第一波）
- 新增 `utils/debug.py`：
  - `debug_print(prefix: str, text: str|list|dict, *, level_required=1, event_number=None, file_path=None, repeat_prefix=True, max_items=None, chunk=10)`
  - 內部：根據 DEBUG_LEVEL 決定是否輸出；根據 DEBUG_TAG_EVENT_ID 決定是否加 [evt#]；用 wrap_text_with_cjk_support 分行；列表/字典進行格式化。
- 套用在三個熱點：
  1) utils/cache.py 的 `_debug()`（exec/rc/stdout/stderr）
  2) core/excel_parser.py 的 [map] keys 輸出（每行 10 項、按等級截斷）
  3) utils/timeline_exporter.py 的 timeline-html 詳細（方案 A：每行 prefix）
- 其餘模塊逐步遷移。

---

## 8. 事件編號傳遞（建議）
- watcher.on_modified / compare_excel_changes 已有 `event_number`，可在呼叫 debug_print 時帶入。
- 無 event_number 場景（例如 cache 複製）：
  - 可傳入 `file_path` 以產生 baseline key 標籤 [bk:...] 作為群組識別。
  - 長遠可用 thread-local 保存最近一次的 (file_path, event_number) 作「上下文」（小心跨檔案干擾）。

---

## 9. 回滾與風險
- 只新增工具，不改業務邏輯；改動點少、易回退。
- 若使用者不習慣新格式，可在 UI 關閉 DEBUG_REPEAT_PREFIX_ON_WRAP 或降低 DEBUG_LEVEL。

---

## 10. 待辦（可選）
- UI：新增 DEBUG_* 設定項
- `debug_print` 工具實作
- 第一波替換三個熱點
- 逐步覆蓋 [value-engine] / [fallback] / [queue] / [poll]

---

## 11. 今日進度更新（2025-09-09）
已完成（第一波）
- 新增 utils/debug.py
  - debug_print：長行換行、每行 timestamp、prefix 重覆、list/dict 格式化、事件/群組標籤（[bk:…]，待 event id context）
  - debug_print_cmd：PowerShell 命令語義分行（-NoProfile/-Command/Copy-Item/-LiteralPath/-Destination/-Force），不會在路徑中間截斷
- utils/cache.py
  - _run_subprocess_copy() 中 exec 訊息改為 debug_print_cmd('copy', cmd, file_path=src)
- core/excel_parser.py
  - [map] 輸出標準化：先摘要，再以 debug_print('map', keys, label='keys', chunk=10) 分頁輸出
- utils/timeline_exporter.py
  - timeline-html 詳細改為 debug_print('timeline-html', {...}) 每行 key=value 輸出
- 設定與 UI
  - 新增 DEBUG_LEVEL/DEBUG_WRAP_WIDTH/DEBUG_MAX_LIST_ITEMS/DEBUG_TRUNCATE_BYTES/DEBUG_REPEAT_PREFIX_ON_WRAP/DEBUG_TAG_EVENT_ID
  - DEBUG_WRAP_WIDTH 預設 180（與比較表寬度對齊）

觀察與建議
- 如需看到 PowerShell 詳細分行，請將 DEBUG_LEVEL 設為 2 或以上；我可加 fallback：在 Level<2 仍打印一行簡要提示
- 可加 DEBUG_KEYS_PER_LINE（控制 [map] 每行 keys 數），預設 10
- 「佇列已接手後續比較與輸出…」文案可改為：「已加入比較佇列，稍後輸出最新結果…」

後續（第二波）
- 事件編號 thread-local 上下文：compare 設置 event_number，debug_print 自動帶 [evt#XXXX]
- 擴展標準化到 [value-engine] / [fallback] / [queue] / [poll]
- Confluence/Jira 同步（Debug 標準化 第一波/第二波）

- UI：新增 DEBUG_* 設定項
- `debug_print` 工具實作
- 第一波替換三個熱點
- 逐步覆蓋 [value-engine] / [fallback] / [queue] / [poll]
