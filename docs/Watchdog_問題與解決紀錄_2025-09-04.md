# Watchdog 問題與解決紀錄（2025-09-04）

本文檔彙整今天在 Watchdog（Excel 監控/比較）調整與測試過程中，遇到的問題、分析、採取的修正與仍待優化的事項。不論成功與否一律詳實記錄，以利明日延續。

---

## 1. 啟動掃描與 UI 設定未嚴格遵守
- 現象
  - 即使在 UI 的「啟動掃描的指定目錄（SCAN_TARGET_FOLDERS）」移除了 `C:\`，啟動時仍掃描過多路徑。
- 根因
  - UI 儲存將「空清單」視為空白不覆蓋，導致 runtime JSON 仍留舊值。
  - main.py 啟動掃描只在 `SCAN_TARGET_FOLDERS` 為真值時才採用；空清單會退回 `WATCH_FOLDERS`。
- 修正
  - ui/settings_ui.py：Lists/Tuples/Dicts 即使為空也一律覆蓋至 runtime JSON（視為「使用者明確清空」）。
  - main.py：啟動掃描優先讀 runtime JSON，只要存在 `SCAN_TARGET_FOLDERS` key（即使是空清單）就以該清單為準；僅 key 不存在時才回退。
- 效果
  - 現在完全遵從 UI 的選擇，不會再「偷偷掃 C:\」。

變更檔案：
- ui/settings_ui.py（_save_and_apply）
- main.py（SCAN_TARGET_FOLDERS 讀取邏輯）

---

## 2. 監控整個磁碟／網路磁碟時 Watchdog 崩潰
- 現象
  - 監控整個磁碟根（如 `C:\`）或 UNC 時偶發崩潰。
- 原因與解法
  - 原生 Observer 在根/UNC 不穩定。改為自動選擇 Watchdog 後端：
    - 偵測到根目錄/UNC 或環境變數 `WATCHDOG_FORCE_POLLING=1` → 使用 PollingObserver（穩定）。
    - 其他情況用原生 Observer（效能佳）。
- 狀態
  - 已實作並生效；啟動時會打印後端選擇說明。

變更檔案：
- main.py（Observer/PollingObserver 自動選擇）

---

## 3. 「快速跳過」錯誤略過即時比較
- 現象
  - 即時修改後無表格，Console 顯示「[快速通過] mtime/size 未變」。
- 根因
  - QUICK_SKIP_BY_STAT 以 mtime/size 判斷無變動，原本即時比較也會套用，易在剛更新 baseline 後誤判。
- 修正
  - 快速跳過僅在「輪詢比較（is_polling=True）」時啟用；即時比較永遠讀取一次，不會被略過。

變更檔案：
- core/comparison.py（QUICK_SKIP 僅輪詢時生效）

---

## 4. MONITOR-ONLY 首次事件的行為與噪音
- 需求
  - 監控大範圍（整個 drive/UNC）時：第一次偵測變更只建立 baseline（本次不比較），第二次才出比較表。
- 修正
  - watcher.on_modified：
    - 先做路由判斷：`WATCH_FOLDERS` 優先於 `MONITOR_ONLY_FOLDERS`。
    - 若為 MONITOR-ONLY 且尚無 baseline → 直接建立 baseline 並 return（避免先印「檔案變更偵測」橫幅）。
  - 加入路徑比對正規化與防呆（normcase、commonpath 與 startswith 後備）。
- Debug 噪音（[route] in_watch=…）：
  - 放在副檔名/忽略目錄檢查之前會打印大量非 Excel 事件（Chrome/系統 log 等）。
  - 建議後續將 [route] 搬到副檔名與忽略檢查之後，或關閉 SHOW_DEBUG_MESSAGES。

變更檔案：
- core/watcher.py（路由優先、MONITOR-ONLY 首見 baseline 快速路徑、路徑判斷強化、[route] debug）

---

## 5. 即時比較「必出表」與公式模式抑制
- 現象
  - FORMULA_ONLY_MODE=True 時，純值變更可能被抑制，看起來像「沒反應」。
- 修正
  - 即時比較（is_polling=False）不套用抑制（allow_suppress=False）：純值變更也會顯示。
  - 若最終分析無「有意義變更」，仍至少輸出表頭與 "(No cell changes)" 作為回饋。

變更檔案：
- core/comparison.py（analyze_meaningful_changes 增加 allow_suppress；即時比較不抑制純值，且最少打印表頭）

---

## 6. 「重試後仍無法讀取檔案」誤判
- 現象
  - 清空內容導致讀取結果是空字典 `{}` 時被判為失敗。
- 修正
  - 僅 `None` 視為失敗；空字典是合法結果。

變更檔案：
- core/comparison.py（讀取失敗判斷：`None` 才算失敗）

---

## 7. 記憶體峰值偏高（~1.5–2.3GB）
- 說明
  - 基準線建立流程包含：快取複製、openpyxl 載入、值引擎解析、JSON 壓縮；短時峰值偏高屬正常，psutil 讀整體 RSS。
- 可行優化（待辦）
  - 動態降級值引擎（polars → polars_xml/xml）於高記憶體時。
  - 更積極釋放（提早 del 大字典/關閉 workbook/強 GC）。
  - 硬節流：記憶體高於門檻時等待至安全再處理下一檔。

---

## 8. 黑色 Console（Tkinter）跨線程錯誤：Tcl_AsyncDelete
- 現象
  - 偶發 `Tcl_AsyncDelete: async handler deleted by the wrong thread`。
- 措施（已套用）
  - ui/console.py
    - add_message：視窗已停或不存在則丟棄訊息。
    - check_messages：若停止/視窗不存在則直接 return，不再 after 重排程。
    - stop：先 `running=False`，再於 UI 線程安全 cancel/quit/destroy。
  - main.py
    - _cleanup_tkinter_vars 不再強行改 `_tk` 指標，只做 gc.collect()。
- 後續正統解（可選）
  - 將 Tk mainloop 放回主線程；watcher/observer 改在背景線程運作（較大改動）。

變更檔案：
- ui/console.py、main.py（清理策略）

---

## 9. 分片註冊（大範圍）→ 回退
- 嘗試
  - 為改善啟動體感，曾加入「C:\/UNC 分片註冊 + 進度」；但在你的環境產生額外干擾（配合 Tk 行為）。
- 決策
  - 已回退到「一次性遞迴註冊」（雖然慢，但最穩定，避免干擾你驗證 compare table）。

變更檔案：
- main.py（還原傳統 schedule → start 流程）

---

## 10. 現在的行為準則（你要求的目標）：
- WATCH_FOLDERS（精準監控）
  - 啟動可選擇先建立 baseline（SCAN_ALL_MODE/SCAN_TARGET_FOLDERS）
  - 檔案一有變更：即時比較，必出表
- MONITOR_ONLY_FOLDERS（廣域監控）
  - 不做啟動掃描；第一次偵測變更：只建 baseline（本次不比較）
  - 同一檔第二次變更：顯示比較表
- 路由優先權：WATCH 優先於 MONITOR-ONLY
- 快速跳過：僅輪詢比較使用；即時比較永遠讀取一次

---

## 11. 建議排除的高噪音資料夾（MONITOR_ONLY_EXCLUDE_FOLDERS）
- Windows：`C:\\Windows`、`C:\\Program Files`、`C:\\Program Files (x86)`、`C:\\ProgramData`、`C:\\$Recycle.Bin`、`C:\\System Volume Information`
- 使用者快取/應用資料：`C:\\Users\\<you>\\AppData\\Local`、`C:\\Users\\<you>\\AppData\\Roaming`（或更精確到 Chrome/OneDrive/Cache 等子項）
- 自家輸出：已啟用 `IGNORE_CACHE_FOLDER` / `IGNORE_LOG_FOLDER`（建議保持）

---

## 12. 驗證清單（明日照此驗）
1) WATCH 範圍：修改一個已有 baseline 的 Excel 檔 → 立即出比較表（純值亦會出）
2) MONITOR-ONLY 範圍：同一 Excel 新檔 → 第一次變更只建 baseline；第二次再改 → 出比較表
3) 監控整個 C:\ 與 WATCH 並存時：WATCH 檔案仍走即時比較（確認 [route] in_watch=True）
4) 關閉 SHOW_DEBUG_MESSAGES 或將 [route] debug 移到副檔名檢查之後 → 不再爆非 Excel 噪音
5) 記憶體：單檔 baseline 峰值觀察；必要時啟動降級策略
6) Console：停止程式（Ctrl+C）不再出 Tcl_AsyncDelete（若仍偶發，評估把 Tk mainloop 移回主線程）

---

## 13. 待辦／後續（Backlog）
- 將 [route] debug 搬到副檔名/忽略之後，或僅對 Excel 檔打印
- 記憶體護欄：高記憶體時降級值引擎與硬節流
-（可選）Tk mainloop 回主線程、watcher 改背景線程
-（可選）分片註冊改為可選開關，預設關閉

---

## 14. 本次修改清單（代碼路徑）
- main.py：
  - 後端自動選擇（PollingObserver vs Observer）
  - 啟動掃描根目錄邏輯（尊重空清單覆蓋）
  - 註冊流程已回退為傳統一次性遞迴
- ui/settings_ui.py：
  - 空清單覆蓋 runtime JSON；AUTO_SYNC_SCAN_TARGETS 行為一致
- core/watcher.py：
  - 路由優先（WATCH 優先於 MONITOR-ONLY）
  - MONITOR-ONLY 首次事件：直接 baseline 並 return
  - 路徑比對強化；[route] debug（暫時保留）
- core/comparison.py：
  - 快速跳過只在輪詢生效
  - 即時比較不抑制純值；至少輸出表頭
  - 讀取失敗判斷調整（`None` 才算失敗）
- ui/console.py：
  - add_message / check_messages / stop：跨線程防護
- main.py：
  - _cleanup_tkinter_vars：移除強行 `_tk` 操作

---

如需立刻把這份紀錄同步到 Confluence 或建立 Jira 工作項追蹤上述待辦，我可以幫你一鍵建立（PR/Jira/Confluence）。請告知你想選擇的下一步。